<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Excel AI Converter - GitHub Pages</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .github-badge {
            background: rgba(255,255,255,0.2);
            border-radius: 25px;
            padding: 8px 16px;
            margin-top: 10px;
            display: inline-block;
        }

        .content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .info-box {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #3498db;
        }

        .info-box.warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            border-left-color: #f39c12;
        }

        .api-section {
            margin-bottom: 30px;
        }

        .api-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .api-status {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: normal;
        }

        .status-valid {
            background: #d4edda;
            color: #155724;
        }

        .status-invalid {
            color: #e74c3c;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .api-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .api-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .api-input.error {
            border-color: #e74c3c;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section.dragover {
            border-color: #3498db;
            background: #e8f4fd;
            transform: scale(1.02);
        }

        .upload-area {
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #6c757d;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .selected-file {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            word-break: break-all;
        }

        .progress-section {
            display: none;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #dee2e6;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .progress-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .progress-header h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .progress-stat {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .progress-stat:hover {
            transform: translateY(-2px);
        }

        .progress-stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
            font-family: 'Courier New', monospace;
        }

        .progress-stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 8px;
            font-weight: 500;
        }

        .progress-bar-container {
            margin-bottom: 25px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            margin: 15px 0;
            border: 2px solid #dee2e6;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.8s ease;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #2c3e50;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
            z-index: 10;
        }

        .progress-text {
            text-align: center;
            color: #495057;
            margin: 15px 0;
            font-weight: 500;
            font-size: 1.2rem;
        }

        .progress-details {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .progress-details h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-steps {
            list-style: none;
            padding: 0;
        }

        .progress-step {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f8f9fa;
            transition: all 0.3s ease;
        }

        .progress-step:last-child {
            border-bottom: none;
        }

        .progress-step-icon {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .progress-step.completed .progress-step-icon {
            background: #27ae60;
            color: white;
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
        }

        .progress-step.active .progress-step-icon {
            background: #3498db;
            color: white;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);
        }

        .progress-step.pending .progress-step-icon {
            background: #e9ecef;
            color: #6c757d;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .progress-step-text {
            flex: 1;
            color: #495057;
            font-size: 1rem;
        }

        .progress-step.completed .progress-step-text {
            color: #27ae60;
            font-weight: 500;
        }

        .progress-step.active .progress-step-text {
            color: #3498db;
            font-weight: 600;
        }

        .result-section {
            display: none;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .result-success {
            color: #27ae60;
            border-left: 5px solid #27ae60;
            background: #d4edda;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .result-error {
            color: #e74c3c;
            border-left: 5px solid #e74c3c;
            background: #f8d7da;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .footer {
            background: rgba(0,0,0,0.7);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-radius: 10px;
            font-size: 14px;
        }

        .footer a {
            color: #3498db;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 2px 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #495057;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .feature-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .api-input-group {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }

            .progress-stats {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 PDF to Excel AI Converter</h1>
            <p>✨ GitHub Pages Edition - Fully Client-Side Processing</p>
            <div class="github-badge">
                📦 No Server Required • 🔒 Privacy-First • 🌐 Works Offline
            </div>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>🎉 Client-Side Processing!</strong> This version runs entirely in your browser. Your files are processed locally and never uploaded to any server, ensuring complete privacy and security.
            </div>

            <div class="info-box warning">
                <strong>⚠️ Browser Requirements:</strong> This application requires a modern browser that supports the File System Access API (Chrome 86+, Edge 86+) for the best experience. Firefox and Safari users will use fallback download methods.
            </div>

            <!-- Features Grid -->
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">🔒</div>
                    <h4>Privacy First</h4>
                    <p>All processing happens in your browser. Your PDFs never leave your device.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🚀</div>
                    <h4>AI Powered</h4>
                    <p>Uses Google Gemini AI for accurate table detection and extraction.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🌐</div>
                    <h4>Works Anywhere</h4>
                    <p>No installation required. Works on any device with a modern browser.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">📊</div>
                    <h4>Excel Output</h4>
                    <p>Generates real Excel files with properly formatted tables and sheets.</p>
                </div>
            </div>

            <!-- API Key Section -->
            <div class="api-section">
                <h3>
                    🔑 Google Gemini API Key
                    <span id="api-status" class="api-status">
                        <span id="status-text">Not configured</span>
                        <span id="status-icon"></span>
                    </span>
                </h3>
                <div class="api-input-group">
                    <input type="password" id="api-key-input" class="api-input" placeholder="Enter your Google Gemini API key...">
                    <button id="validate-btn" class="btn btn-primary">
                        <span id="validate-text">Validate</span>
                        <div id="validate-spinner" class="loading-spinner hidden"></div>
                    </button>
                </div>
                <div id="api-error" class="error-message hidden"></div>
                <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                    Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> (Free tier available)
                </p>
            </div>

            <!-- File Upload Section -->
            <div class="upload-section" id="upload-section">
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">📄</div>
                    <div class="upload-text">
                        <strong>Drag and drop a PDF file here</strong><br>
                        or click to browse files
                    </div>
                    <button id="browse-btn" class="btn btn-primary" disabled>Browse Files</button>
                    <input type="file" id="file-input" class="file-input" accept=".pdf">
                </div>
                <div id="selected-file" class="selected-file hidden">
                    <strong>Selected file:</strong> <span id="file-name"></span>
                    <button id="remove-file" class="btn btn-secondary btn-small" style="float:right;">Remove</button>
                </div>
            </div>

            <!-- Process Button -->
            <div class="button-group">
                <button id="process-btn" class="btn btn-success" disabled>
                    <span id="process-text">🚀 Process PDF</span>
                    <div id="process-spinner" class="loading-spinner hidden"></div>
                </button>
            </div>

            <!-- Enhanced Progress Section -->
            <div id="progress-section" class="progress-section">
                <div class="progress-header">
                    <h3>🔄 Processing your PDF...</h3>
                    <p style="color: #6c757d; margin-top: 5px;">AI is extracting tables from your document locally</p>
                </div>
                
                <!-- Progress Statistics -->
                <div class="progress-stats">
                    <div class="progress-stat">
                        <div id="elapsed-time" class="progress-stat-value">0:00</div>
                        <div class="progress-stat-label">⏱️ Time Elapsed</div>
                    </div>
                    <div class="progress-stat">
                        <div id="pages-processed" class="progress-stat-value">0</div>
                        <div class="progress-stat-label">📄 Pages Processed</div>
                    </div>
                    <div class="progress-stat">
                        <div id="tables-found" class="progress-stat-value">0</div>
                        <div class="progress-stat-label">📊 Tables Found</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                        <div id="progress-percentage" class="progress-percentage">0%</div>
                    </div>
                    <div id="progress-text" class="progress-text">Initializing...</div>
                </div>

                <!-- Detailed Progress Steps -->
                <div class="progress-details">
                    <h4>🔍 Processing Steps</h4>
                    <ul class="progress-steps">
                        <li class="progress-step pending" id="step-load">
                            <div class="progress-step-icon">1</div>
                            <div class="progress-step-text">📥 Loading PDF File</div>
                        </li>
                        <li class="progress-step pending" id="step-convert">
                            <div class="progress-step-icon">2</div>
                            <div class="progress-step-text">🖼️ Converting Pages to Images</div>
                        </li>
                        <li class="progress-step pending" id="step-ai">
                            <div class="progress-step-icon">3</div>
                            <div class="progress-step-text">🤖 AI Table Extraction</div>
                        </li>
                        <li class="progress-step pending" id="step-excel">
                            <div class="progress-step-icon">4</div>
                            <div class="progress-step-text">📊 Generating Excel File</div>
                        </li>
                        <li class="progress-step pending" id="step-complete">
                            <div class="progress-step-icon">✓</div>
                            <div class="progress-step-text">🎉 Processing Complete</div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Result Section -->
            <div id="result-section" class="result-section">
                <h3>Result</h3>
                <div id="result-content"></div>
                <div id="result-buttons" class="button-group hidden">
                    <button id="download-btn" class="btn btn-success">💾 Save Excel File</button>
                    <button id="process-another" class="btn btn-primary">📄 Process Another PDF</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>🚀 PDF to Excel AI Converter • GitHub Pages Edition • Powered by Google Gemini AI</p>
            <p>
                <a href="https://github.com/InderjeetAI/PDF-To-Excel-AI-Converter" target="_blank">📦 Source Code</a> • 
                <a href="#" onclick="showUsageInstructions()">📖 Usage Guide</a> • 
                <a href="#" onclick="showPrivacyInfo()">🔒 Privacy Policy</a>
            </p>
        </div>
    </div>

    <script type="module">
        import { getDocument, GlobalWorkerOptions } from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs';
        
        // Set up PDF.js worker
        GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

        console.log("🎉 Client-Side PDF Converter Loaded Successfully!");
        
        class ClientSidePDFConverter {
            constructor() {
                this.apiKey = "";
                this.selectedFile = null;
                this.timerInterval = null;
                this.startTime = null;
                this.currentExcelBlob = null;
                this.currentFileName = null;
                this.pagesProcessed = 0;
                this.tablesFound = 0;
                
                this.initializeElements();
                this.attachEventListeners();
                this.loadSavedApiKey();
                
                console.log("🚀 Client-Side PDF Converter initialized!");
            }

            initializeElements() {
                // API Key elements
                this.apiKeyInput = document.getElementById("api-key-input");
                this.validateBtn = document.getElementById("validate-btn");
                this.validateText = document.getElementById("validate-text");
                this.validateSpinner = document.getElementById("validate-spinner");
                this.apiStatus = document.getElementById("api-status");
                this.statusText = document.getElementById("status-text");
                this.statusIcon = document.getElementById("status-icon");
                this.apiError = document.getElementById("api-error");

                // Upload elements
                this.uploadSection = document.getElementById("upload-section");
                this.uploadArea = document.getElementById("upload-area");
                this.browseBtn = document.getElementById("browse-btn");
                this.fileInput = document.getElementById("file-input");
                this.selectedFileDiv = document.getElementById("selected-file");
                this.fileName = document.getElementById("file-name");
                this.removeFileBtn = document.getElementById("remove-file");

                // Process elements
                this.processBtn = document.getElementById("process-btn");
                this.processText = document.getElementById("process-text");
                this.processSpinner = document.getElementById("process-spinner");

                // Progress elements
                this.progressSection = document.getElementById("progress-section");
                this.progressFill = document.getElementById("progress-fill");
                this.progressText = document.getElementById("progress-text");
                this.progressPercentage = document.getElementById("progress-percentage");
                this.elapsedTimeDisplay = document.getElementById("elapsed-time");
                this.pagesProcessedDisplay = document.getElementById("pages-processed");
                this.tablesFoundDisplay = document.getElementById("tables-found");

                // Progress steps
                this.stepLoad = document.getElementById("step-load");
                this.stepConvert = document.getElementById("step-convert");
                this.stepAi = document.getElementById("step-ai");
                this.stepExcel = document.getElementById("step-excel");
                this.stepComplete = document.getElementById("step-complete");

                // Result elements
                this.resultSection = document.getElementById("result-section");
                this.resultContent = document.getElementById("result-content");
                this.resultButtons = document.getElementById("result-buttons");
                this.downloadBtn = document.getElementById("download-btn");
                this.processAnotherBtn = document.getElementById("process-another");
            }

            attachEventListeners() {
                // API Key validation
                this.validateBtn.addEventListener("click", () => this.validateApiKey());
                this.apiKeyInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") this.validateApiKey();
                });

                // File upload
                this.browseBtn.addEventListener("click", () => this.fileInput.click());
                this.uploadArea.addEventListener("click", () => this.fileInput.click());
                this.fileInput.addEventListener("change", (e) => this.handleFileSelect(e.target.files[0]));
                this.removeFileBtn.addEventListener("click", () => this.removeFile());

                // Drag and drop
                this.uploadArea.addEventListener("dragover", (e) => this.handleDragOver(e));
                this.uploadArea.addEventListener("dragleave", (e) => this.handleDragLeave(e));
                this.uploadArea.addEventListener("drop", (e) => this.handleDrop(e));

                // Process PDF
                this.processBtn.addEventListener("click", () => this.processPDF());

                // Result actions
                this.downloadBtn.addEventListener("click", () => this.downloadFile());
                this.processAnotherBtn.addEventListener("click", () => this.resetForm());
            }

            loadSavedApiKey() {
                const saved = localStorage.getItem("gemini_api_key_github_pages");
                if (saved) {
                    this.apiKeyInput.value = saved;
                    this.validateApiKey();
                }
            }

            async validateApiKey() {
                const key = this.apiKeyInput.value.trim();
                if (!key) {
                    this.showApiError("Please enter an API key");
                    return;
                }

                this.setValidating(true);
                this.hideApiError();

                try {
                    // Test the API key with a simple request
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: "Hello, this is a test." }]
                            }]
                        })
                    });

                    if (response.ok) {
                        this.apiKey = key;
                        localStorage.setItem("gemini_api_key_github_pages", key);
                        this.setApiStatus(true, "Valid API key");
                        this.updateUI();
                    } else {
                        const error = await response.json();
                        this.setApiStatus(false, "Invalid API key");
                        this.showApiError(error.error?.message || "Invalid API key");
                    }
                } catch (error) {
                    this.setApiStatus(false, "Validation failed");
                    this.showApiError("Network error during validation. Check your internet connection.");
                } finally {
                    this.setValidating(false);
                }
            }

            setValidating(isValidating) {
                this.validateBtn.disabled = isValidating;
                this.validateText.textContent = isValidating ? "Validating..." : "Validate";
                this.validateSpinner.classList.toggle("hidden", !isValidating);
            }

            setApiStatus(isValid, message) {
                this.statusText.textContent = message;
                this.statusIcon.textContent = isValid ? "✅" : "❌";
                this.apiStatus.className = `api-status ${isValid ? "status-valid" : "status-invalid"}`;
            }

            showApiError(message) {
                this.apiError.textContent = message;
                this.apiError.classList.remove("hidden");
                this.apiKeyInput.classList.add("error");
            }

            hideApiError() {
                this.apiError.classList.add("hidden");
                this.apiKeyInput.classList.remove("error");
            }

            handleDragOver(e) {
                e.preventDefault();
                this.uploadSection.classList.add("dragover");
            }

            handleDragLeave(e) {
                e.preventDefault();
                this.uploadSection.classList.remove("dragover");
            }

            handleDrop(e) {
                e.preventDefault();
                this.uploadSection.classList.remove("dragover");
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.handleFileSelect(files[0]);
                }
            }

            handleFileSelect(file) {
                if (!file) return;

                if (file.type !== "application/pdf") {
                    alert("Please select a PDF file.");
                    return;
                }

                if (file.size > 50 * 1024 * 1024) { // 50MB limit for client-side processing
                    alert("File size must be less than 50MB for client-side processing.");
                    return;
                }

                this.selectedFile = file;
                this.fileName.textContent = file.name;
                this.selectedFileDiv.classList.remove("hidden");
                this.updateUI();
            }

            removeFile() {
                this.selectedFile = null;
                this.selectedFileDiv.classList.add("hidden");
                this.fileInput.value = "";
                this.updateUI();
            }

            updateUI() {
                const hasApiKey = !!this.apiKey;
                const hasFile = !!this.selectedFile;

                this.browseBtn.disabled = !hasApiKey;
                this.processBtn.disabled = !hasApiKey || !hasFile;
            }

            async processPDF() {
                if (!this.apiKey || !this.selectedFile) return;

                console.log("🚀 Starting client-side PDF processing...");
                this.showProgress();
                this.startTimer();
                this.resetCounters();

                try {
                    // Step 1: Load PDF
                    this.updateProgressStep("load", "active");
                    this.updateProgress(5, "Loading PDF file...");
                    
                    const arrayBuffer = await this.selectedFile.arrayBuffer();
                    const pdf = await getDocument({ data: arrayBuffer }).promise;
                    
                    this.updateProgressStep("load", "completed");
                    this.updateProgressStep("convert", "active");
                    this.updateProgress(15, "Converting PDF pages to images...");

                    // Step 2: Convert pages to images
                    const images = [];
                    const totalPages = pdf.numPages;
                    
                    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                        this.updateProgress(15 + (pageNum / totalPages) * 30, `Converting page ${pageNum} of ${totalPages}...`);
                        
                        const page = await pdf.getPage(pageNum);
                        const viewport = page.getViewport({ scale: 2.0 });
                        
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        await page.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;

                        // Convert to blob
                        const blob = await new Promise(resolve => {
                            canvas.toBlob(resolve, 'image/jpeg', 0.9);
                        });
                        
                        images.push({ pageNum, blob });
                        this.pagesProcessed = pageNum;
                        this.updateStats();
                    }

                    this.updateProgressStep("convert", "completed");
                    this.updateProgressStep("ai", "active");
                    this.updateProgress(45, "Processing images with AI...");

                    // Step 3: Process with AI
                    const allTables = [];
                    
                    for (let i = 0; i < images.length; i++) {
                        const { pageNum, blob } = images[i];
                        this.updateProgress(45 + (i / images.length) * 35, `AI processing page ${pageNum}...`);
                        
                        const tables = await this.processImageWithAI(blob, pageNum);
                        allTables.push(...tables);
                        this.tablesFound = allTables.length;
                        this.updateStats();
                    }

                    this.updateProgressStep("ai", "completed");
                    this.updateProgressStep("excel", "active");
                    this.updateProgress(85, "Creating Excel file...");

                    // Step 4: Create Excel file
                    const excelBlob = this.createExcelFile(allTables);
                    
                    this.updateProgressStep("excel", "completed");
                    this.updateProgressStep("complete", "completed");
                    this.updateProgress(100, "Processing complete!");

                    this.showSuccess(excelBlob);

                } catch (error) {
                    console.error("Processing error:", error);
                    this.showError(error.message);
                }
            }

            async processImageWithAI(imageBlob, pageNum) {
                try {
                    // Convert blob to base64
                    const base64 = await this.blobToBase64(imageBlob);
                    const base64Data = base64.split(',')[1]; // Remove data URL prefix

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    {
                                        text: `Analyze this image and extract all tables you can find. For each table:
1. Convert it to CSV format
2. Include all rows and columns
3. Use commas as separators
4. If there are multiple tables, separate them with "---TABLE_SEPARATOR---"
5. If no tables are found, respond with "NO_TABLES_FOUND"

Please extract the data as accurately as possible, maintaining the structure and alignment.`
                                    },
                                    {
                                        inline_data: {
                                            mime_type: "image/jpeg",
                                            data: base64Data
                                        }
                                    }
                                ]
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`AI API error: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!text || text.includes("NO_TABLES_FOUND")) {
                        return [];
                    }

                    // Parse multiple tables
                    const tables = text.split("---TABLE_SEPARATOR---");
                    const parsedTables = [];

                    tables.forEach((tableData, index) => {
                        const cleanData = tableData.trim();
                        if (cleanData) {
                            parsedTables.push({
                                page: pageNum,
                                table: index + 1,
                                data: cleanData,
                                sheetName: `Page_${pageNum}${tables.length > 1 ? `_Table_${index + 1}` : ''}`
                            });
                        }
                    });

                    return parsedTables;

                } catch (error) {
                    console.error(`Error processing page ${pageNum}:`, error);
                    return [];
                }
            }

            createExcelFile(tables) {
                try {
                    const workbook = XLSX.utils.book_new();

                    if (tables.length === 0) {
                        // Create empty sheet if no tables found
                        const worksheet = XLSX.utils.aoa_to_sheet([['No tables found in PDF']]);
                        XLSX.utils.book_append_sheet(workbook, worksheet, 'Result');
                    } else {
                        tables.forEach(table => {
                            try {
                                // Parse CSV data
                                const rows = table.data.split('\n').map(row => 
                                    row.split(',').map(cell => cell.trim())
                                );
                                
                                const worksheet = XLSX.utils.aoa_to_sheet(rows);
                                
                                // Clean sheet name for Excel compatibility
                                let sheetName = table.sheetName.substring(0, 31);
                                sheetName = sheetName.replace(/[\/\\*\[\]:?]/g, '_');
                                
                                XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
                            } catch (error) {
                                console.error(`Error creating sheet for page ${table.page}:`, error);
                            }
                        });
                    }

                    // Generate Excel file
                    const excelBuffer = XLSX.write(workbook, { 
                        bookType: 'xlsx', 
                        type: 'array',
                        compression: true
                    });
                    
                    return new Blob([excelBuffer], { 
                        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                    });

                } catch (error) {
                    console.error("Error creating Excel file:", error);
                    throw new Error("Failed to create Excel file");
                }
            }

            async blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            updateProgressStep(stepName, status) {
                const stepElement = document.getElementById(`step-${stepName}`);
                if (stepElement) {
                    stepElement.className = `progress-step ${status}`;
                    
                    if (status === "completed") {
                        const icon = stepElement.querySelector(".progress-step-icon");
                        icon.textContent = "✓";
                    }
                    
                    console.log(`📋 Step ${stepName}: ${status}`);
                }
            }

            showProgress() {
                this.progressSection.classList.remove("hidden");
                this.resultSection.classList.add("hidden");
                this.processBtn.disabled = true;
                this.processText.textContent = "Processing...";
                this.processSpinner.classList.remove("hidden");
                
                // Reset all steps
                ["load", "convert", "ai", "excel", "complete"].forEach(step => {
                    this.updateProgressStep(step, "pending");
                });
                
                console.log("📊 Progress section shown");
            }

            updateProgress(progress, message) {
                this.progressFill.style.width = `${progress}%`;
                this.progressPercentage.textContent = `${Math.round(progress)}%`;
                this.progressText.textContent = message;
                
                console.log(`📊 Progress: ${progress}% - ${message}`);
            }

            resetCounters() {
                this.pagesProcessed = 0;
                this.tablesFound = 0;
                this.updateStats();
            }

            updateStats() {
                this.pagesProcessedDisplay.textContent = this.pagesProcessed;
                this.tablesFoundDisplay.textContent = this.tablesFound;
            }

            showSuccess(excelBlob) {
                this.stopTimer();
                this.hideProgress();
                
                this.currentExcelBlob = excelBlob;
                this.currentFileName = this.selectedFile.name.replace('.pdf', '.xlsx');
                
                const processingTime = this.getElapsedTime();
                
                this.resultContent.innerHTML = `
                    <div class="result-success">
                        <strong>✅ Success!</strong> Your PDF has been processed successfully.
                        <br><small>Processing completed in ${processingTime}</small>
                        <br><strong>Ready to save:</strong> <code>${this.currentFileName}</code>
                        <br><strong>Pages processed:</strong> ${this.pagesProcessed}
                        <br><strong>Tables found:</strong> ${this.tablesFound}
                        <br><small>Click "Save Excel File" to download to your device</small>
                    </div>
                `;
                
                this.resultSection.style.display = "block";
                this.resultButtons.classList.remove("hidden");
                this.resultSection.classList.remove("hidden");
                
                console.log("🎉 Processing completed successfully!");
            }

            showError(message) {
                this.stopTimer();
                this.hideProgress();
                
                this.resultContent.innerHTML = `
                    <div class="result-error">
                        <strong>❌ Error:</strong> ${message}
                        <br><small>Failed after ${this.getElapsedTime()}</small>
                    </div>
                `;
                
                this.resultButtons.classList.add("hidden");
                this.resultSection.classList.remove("hidden");
                this.resetProcessButton();
                
                console.error("❌ Processing failed:", message);
            }

            hideProgress() {
                this.progressSection.classList.add("hidden");
                this.resetProcessButton();
            }

            resetProcessButton() {
                this.processBtn.disabled = false;
                this.processText.textContent = "🚀 Process PDF";
                this.processSpinner.classList.add("hidden");
            }

            async downloadFile() {
                if (!this.currentExcelBlob || !this.currentFileName) {
                    alert("No file available for download.");
                    return;
                }

                try {
                    // Show loading state
                    const originalText = this.downloadBtn.textContent;
                    this.downloadBtn.disabled = true;
                    this.downloadBtn.innerHTML = "<div class='loading-spinner'></div> Preparing download...";
                    
                    // Try modern File System Access API first (Chrome 86+)
                    if ("showSaveFilePicker" in window) {
                        try {
                            const fileHandle = await window.showSaveFilePicker({
                                suggestedName: this.currentFileName,
                                types: [{
                                    description: "Excel files",
                                    accept: {
                                        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet": [".xlsx"]
                                    }
                                }]
                            });
                            
                            const writable = await fileHandle.createWritable();
                            await writable.write(this.currentExcelBlob);
                            await writable.close();
                            
                            this.downloadBtn.disabled = false;
                            this.downloadBtn.innerHTML = originalText;
                            
                            alert(`File saved successfully as ${this.currentFileName}`);
                            return;
                            
                        } catch (saveError) {
                            if (saveError.name === "AbortError") {
                                this.downloadBtn.disabled = false;
                                this.downloadBtn.innerHTML = originalText;
                                return;
                            }
                        }
                    }
                    
                    // Fallback method for other browsers
                    const url = URL.createObjectURL(this.currentExcelBlob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = this.currentFileName;
                    link.style.display = "none";
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    this.downloadBtn.disabled = false;
                    this.downloadBtn.innerHTML = originalText;
                    
                } catch (error) {
                    console.error("Download error:", error);
                    alert("Error downloading file. Please try again.");
                    
                    this.downloadBtn.disabled = false;
                    this.downloadBtn.innerHTML = "💾 Save Excel File";
                }
            }

            resetForm() {
                this.removeFile();
                this.resultSection.classList.add("hidden");
                this.progressSection.classList.add("hidden");
                this.currentExcelBlob = null;
                this.currentFileName = null;
                this.pagesProcessed = 0;
                this.tablesFound = 0;
                this.updateStats();
                this.updateUI();
                
                console.log("🔄 Form reset");
            }

            startTimer() {
                this.startTime = Date.now();
                this.timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    this.elapsedTimeDisplay.textContent = this.formatTime(elapsed);
                }, 1000);
                
                console.log("⏱️ Timer started");
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                
                console.log("⏱️ Timer stopped");
            }

            getElapsedTime() {
                if (!this.startTime) return "0s";
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                return this.formatTime(elapsed);
            }

            formatTime(seconds) {
                if (seconds < 60) {
                    return `0:${seconds.toString().padStart(2, "0")}`;
                } else if (seconds < 3600) {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins}:${secs.toString().padStart(2, "0")}`;
                } else {
                    const hours = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    return `${hours}:${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
                }
            }
        }

        // Initialize the application
        document.addEventListener("DOMContentLoaded", () => {
            window.pdfConverter = new ClientSidePDFConverter();
        });

        // Global utility functions
        window.showUsageInstructions = function() {
            alert(`📖 Usage Instructions:

1. Get a Google Gemini API key from Google AI Studio (free tier available)
2. Enter and validate your API key
3. Select or drag & drop a PDF file
4. Click "Process PDF" to start extraction
5. Wait for AI processing to complete
6. Save the generated Excel file

Features:
• Fully client-side processing (no data leaves your browser)
• Supports multiple tables per page
• Creates properly formatted Excel files
• Works offline after initial load

Browser Requirements:
• Modern browser with File System Access API support (Chrome 86+, Edge 86+)
• JavaScript enabled
• Minimum 4GB RAM recommended for large PDFs`);
        };

        window.showPrivacyInfo = function() {
            alert(`🔒 Privacy Policy:

This application processes your PDF files entirely in your browser:

✅ What we DON'T do:
• No file uploads to our servers
• No data storage on our servers  
• No tracking or analytics
• No personal information collection

✅ What happens to your data:
• PDF files are processed locally in your browser
• Images are sent directly to Google Gemini AI API
• Results are generated and saved locally
• API key is stored only in your browser's local storage

✅ Third-party services:
• Google Gemini AI API for table extraction
• PDF.js for PDF processing
• SheetJS for Excel generation

Your privacy and data security are our top priorities.`);
        };
    </script>
</body>
</html>
